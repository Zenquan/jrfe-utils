<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: DanmuService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: DanmuService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const defaultOption = {
  maxSpeed: 10,
  minSpeed: 3,
  spaceRatio: 20,
  danmakuLength: 5
};
let dep = {};

/**
 * @author Zenquan
 * @description 作用：弹幕/走马灯服务
 * @date 2021/01/13
 */
class DanmuService {
  constructor(el, data = [], option = {}) {
    if (typeof el !== "object") throw new Error("传入非法el");
    if (!data.length) return console.log("没有需要滚动的弹幕");
    this.option = Object.assign(defaultOption, option);
    let { danmakuLength } = this.option;
    let elSize = el.getBoundingClientRect();
    this.$el = el;
    this.elWidth = elSize.width;
    this.elHeight = elSize.height;
    this.data = data;
    this.danmaku = data.splice(0, danmakuLength);
    this.aliveItems = [];
    this.deatdItems = [];
    this.init();
  }
  init() {
    while (this.danmaku.length) {
      let danmakuData = this.danmaku.shift();
      let dom = this.createDom(danmakuData);
      this.aliveItems.push(dom);
      this.$el.appendChild(dom);
      this.setDomPosition(dom);
      this.setDomSpeed(dom);
    }
    this.animationTimer();
  }
  createDom(danmakuData) {
    let wrap = document.createElement("div");
    let dom = document.createElement("div");
    let img = document.createElement("img");
    img.src = danmakuData.faceUrl;
    dom.innerHTML = danmakuData.title;
    wrap.appendChild(img);
    wrap.appendChild(dom);
    return wrap;
  }
  setDomPosition(dom) {
    Math.random() > 0.5
      ? dom.setAttribute("class", "danmaku-item one")
      : dom.setAttribute("class", "danmaku-item two");

    let domSize = dom.getBoundingClientRect();
    let domWidth = domSize.width;
    let domHeight = domSize.height;
    let spaceRatio = this.option.spaceRatio;
    let danmakuSpace = parseInt(
      Math.random() * ((this.elHeight - domHeight) / spaceRatio)
    );
    let domTop = danmakuSpace * spaceRatio;
    // if(this.checkOverlap(domTop)) return this.setDomPosition(dom)
    dom.style = `top: ${domTop}px;transform: translateX(${this.elWidth +
      50}px)`;
  }
  setDomSpeed(dom) {
    let { maxSpeed, minSpeed } = this.option;
    let second = parseInt(Math.random() * (maxSpeed - minSpeed) + minSpeed);
    let speed = (this.elWidth / (second * 60)).toFixed(3);
    // console.log('speed>>>', speed, this.elWidth)
    dom.setAttribute("data-speed", speed);
  }
  animationTimer() {
    window.requestAnimationFrame(() => {
      for (let i = 0; i &lt; this.aliveItems.length; i++) {
        let dom = this.aliveItems[i];
        let domSpeed = dom.getAttribute("data-speed");
        let domLeft = dom.getBoundingClientRect().left;
        let domWidth = dom.getBoundingClientRect().width;
        dom.style.transform = `translateX(${domLeft - domSpeed}px)`;
        if (domLeft &lt; -domWidth) {
          this.deatdItems.push(...this.aliveItems.splice(i, 1));
          this.notifyAddDom();
          i--;
        }
      }
      this.animationTimer();
    });
  }
  checkOverlap(domTop) {
    for (let item of this.aliveItems) {
      let itemSize = item.getBoundingClientRect();
      let top = itemSize.top;
      let height = itemSize.height;
      console.log(Math.abs(domTop - top) &lt; height);
      if (Math.abs(domTop - top) &lt; height) return true;
    }
    return false;
  }
  notifyAddDom() {
    if (!this.data.length) {
      return this.emit("nodata");
    }
    let danmakuData = this.data.shift();
    let dom = this.deatdItems.shift();
    let container = dom.querySelector("div");
    let imgDom = dom.querySelector("img");
    container.innerHTML = danmakuData.title;
    imgDom.src = danmakuData.faceUrl;
    this.aliveItems.push(dom);
    this.setDomPosition(dom);
    this.setDomSpeed(dom);
  }
  /**
   * @description 作用：监听事件
   * @param envet 事件
   * @param fn 函数
  */
  on(event, fn) {
    dep[event] = fn;
  }
  emit(event) {
    dep[event]();
  }
  /**
   * @description 作用：往后推入弹幕数据
   * @param newdatas 弹幕数据
  */
  appendData(newdatas) {
    this.data = newdatas;
    this.notifyAddDom();
  }
}

export default DanmuService;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArrayFn.html">ArrayFn</a></li><li><a href="DanmuService.html">DanmuService</a></li><li><a href="ImageService.html">ImageService</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Wed Jan 13 2021 22:09:20 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
